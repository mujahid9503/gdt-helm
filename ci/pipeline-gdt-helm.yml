resource_types:
- name: helm
  type: docker-image
  source:
    repository: typositoire/concourse-helm3-resource

- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource

resources:
  - name: gdt-testing-phase
    type: git
    webhook_token: ((github-webhook-token))
    source:
      uri: https://github.com/mujahid9503/gdt-helm.git
      branch: main
      username: ((git-username))
      password: ((git-password))

  - name: docker-hub
    type: docker-image
    source:
      username: ((hub-username))
      password: ((hub-password))
      repository: 23380/test-image-9

  - name: helm-deploy-mumbai
    type: helm
    source:
      cluster_url: https://75D5EF5B0DBF24B3752B4BE445E12984.gr7.ap-south-1.eks.amazonaws.com
      cluster_ca: ((cluster-ca-mumbai))
      token: ((token-mumbai))
      repos:
        - name: git-repo
          url: https://mujahid9503.github.io/gdt-helm/

  - name: helm-deploy-london
    type: helm
    source:
      cluster_url: https://0B3E842D45FDE12169A59FB07EB60DF6.gr7.eu-west-2.eks.amazonaws.com
      cluster_ca: ((cluster-ca-london))
      token: ((token-london))
      repos:
        - name: git-repo
          url: https://mujahid9503.github.io/gdt-helm/

  - name: slack
    type: slack-notification
    icon: slack
    source:
      url: https://hooks.slack.com/services/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

jobs:
- name: build-and-push
  serial: false
  plan:
  - get: gdt-testing-phase
    trigger: true
  - task: jar-build-gdt
    file: gdt-testing-phase/ci/tasks/maven_build.yml
  - put: docker-hub
    params:
      build: gdt-testing-phase/
  on_success:
    put: slack
    params:
      text: "Build and Pushed image to Hub is completed..:yay:"
      silent: true
  on_failure:
    put: slack
    params:
      text: "Failed to Build and push image.."
      silent: true
- name: deploy asia region
  serial: false
  plan: 
  - get: gdt-testing-phase
    passed: [build-and-deploy]
    trigger: true
  - put: helm-deploy-mumbai
    params:
      chart: git-repo/helmchart
      release: deploy
      uninstall: false
  on_success:
    put: slack
    params:
      text: "Deployment is successful in Asia region..:yay:"
      silent: true
  on_failure:
    put: slack
    params:
      text: "Deployment failed in Asia region.."
      silent: true
- name: deploy europe region
  serial: false
  plan:  
  - get: gdt-testing-phase
    passed: [build-and-deploy]
    trigger: true
  - put: helm-deploy-london
    params:
      chart: git-repo/helmchart
      release: deploy
      uninstall: false
  on_success:
    put: slack
    params:
      text: "Deployment is successful in Europe region..:yay:"
      silent: true
  on_failure:
    put: slack
    params:
      text: "Deployment failed in Europe region.."
      silent: true